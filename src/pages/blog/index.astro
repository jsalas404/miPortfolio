---
import Layout from "../../layouts/Layout.astro"
import Navbar from "../../components/Navbar.astro"
import Footer from "../../components/Footer.astro"
import { getCollection } from "astro:content"
import { url } from "../../utils/url"
import { readingTime } from "../../utils/readingTime"

const posts = await getCollection("blog", ({ data }) => data.draft === false)
posts.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())

const allTags = [...new Set(posts.flatMap(p => p.data.tags))]
---

<Layout title="Blog - Jose Salas | Desarrollo Web y Tecnología">
  <Navbar />
  <main class="max-w-5xl mx-auto px-6 py-32">

    <p class="animate-fade-up text-sm font-medium text-gray-400 uppercase tracking-widest mb-4" style="animation-delay: 0.1s; opacity: 0; animation-fill-mode: forwards;">
      Blog
    </p>
    <h1 class="animate-fade-up text-3xl font-bold text-gray-900 mb-4 dark:text-gray-100" style="animation-delay: 0.2s; opacity: 0; animation-fill-mode: forwards;">
      Artículos y notas
    </h1>

    <p
      class="animate-fade-up text-gray-500 dark:text-gray-400 mb-8 max-w-lg"
      style="animation-delay: 0.25s; opacity: 0; animation-fill-mode: forwards;"
    >
      Apuntes, reflexiones y cosas que aprendo mientras construyo. Sin filtros, solo experiencia real.
    </p>

    <!-- Buscador y filtros -->
    <div class="flex flex-col sm:flex-row gap-3 mb-8">

      <input
        id="search"
        type="text"
        placeholder="Buscar por título..."
        class="flex-1 px-5 py-3 text-sm border border-gray-200 rounded-2xl focus:outline-none focus:border-gray-400 transition-colors placeholder:text-gray-400 dark:bg-gray-900 dark:border-gray-700 dark:text-gray-100 dark:placeholder-gray-500"
      />

      <!-- Custom select — Tags -->
      <div class="relative min-w-44">
        <button
          id="tag-btn"
          class="w-full flex items-center justify-between gap-3 px-5 py-3 text-sm border border-gray-200 rounded-2xl text-gray-500 bg-white hover:border-gray-400 transition-colors dark:bg-gray-900 dark:border-gray-700 dark:text-gray-400 dark:hover:border-gray-500"
        >
          <span id="tag-label">Todos los temas</span>
          <svg class="dropdown-chevron w-4 h-4 shrink-0 transition-transform" id="tag-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
        <div id="tag-options" class="dropdown-options hidden absolute z-50 top-full mt-1 w-full bg-white border border-gray-200 rounded-xl shadow-md dark:bg-gray-900 dark:border-gray-700">
          <button data-value="" class="tag-option w-full text-left px-5 py-3 text-sm text-gray-700 hover:bg-gray-50 transition-colors first:rounded-t-xl last:rounded-b-xl dark:text-gray-300 dark:hover:bg-gray-800">
            Todos los temas
          </button>
          {allTags.map(tag => (
            <button data-value={tag} class="tag-option w-full text-left px-5 py-3 text-sm text-gray-700 hover:bg-gray-50 transition-colors first:rounded-t-xl last:rounded-b-xl dark:text-gray-300 dark:hover:bg-gray-800">
              {tag}
            </button>
          ))}
        </div>
      </div>

      <!-- Custom select — Fecha -->
      <div class="relative min-w-44">
        <button
          id="date-btn"
          class="w-full flex items-center justify-between gap-3 px-5 py-3 text-sm border border-gray-200 rounded-2xl text-gray-500 bg-white hover:border-gray-400 transition-colors dark:bg-gray-900 dark:border-gray-700 dark:text-gray-400 dark:hover:border-gray-500"
        >
          <span id="date-label">Más recientes</span>
          <svg class="dropdown-chevron w-4 h-4 shrink-0 transition-transform" id="date-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <polyline points="6 9 12 15 18 9"/>
          </svg>
        </button>
        <div id="date-options" class="dropdown-options hidden absolute z-50 top-full mt-1 w-full bg-white border border-gray-200 rounded-xl shadow-md dark:bg-gray-900 dark:border-gray-700">
          <button data-value="newest" class="date-option w-full text-left px-5 py-3 text-sm text-gray-700 hover:bg-gray-50 transition-colors first:rounded-t-xl last:rounded-b-xl dark:text-gray-300 dark:hover:bg-gray-800">
            Más recientes
          </button>
          <button data-value="oldest" class="date-option w-full text-left px-5 py-3 text-sm text-gray-700 hover:bg-gray-50 transition-colors first:rounded-t-xl last:rounded-b-xl dark:text-gray-300 dark:hover:bg-gray-800">
            Más antiguos
          </button>
        </div>
      </div>

    </div>

    <p id="results-count" class="animate-fade-up text-xs text-gray-400 mb-6" style="animation-delay: 0.3s; opacity: 0; animation-fill-mode: forwards;">
      {posts.length} artículos
    </p>

    <div id="posts-grid" class="animate-fade-up grid md:grid-cols-2 lg:grid-cols-3 gap-4" style="animation-delay: 0.4s; opacity: 0; animation-fill-mode: forwards;">
      {posts.map((post) => (
        <article
          class="post-card group p-6 border border-gray-100 rounded-2xl hover:border-gray-300 transition-all cursor-pointer dark:border-gray-800 dark:hover:border-gray-600"
          data-title={post.data.title.toLowerCase()}
          data-tags={post.data.tags.join(",").toLowerCase()}
          data-date={post.data.date.toISOString()}
        >
          <a href={url(`blog/${post.slug}`)} class="block h-full">
            <time class="text-xs text-gray-400 mb-3 block">
              {post.data.date.toLocaleDateString("es-ES", {
                year: "numeric",
                month: "long",
                day: "numeric",
              })} · {readingTime(post.body)}
            </time>
            <h2 class="font-semibold text-gray-900 leading-snug mb-3 group-hover:text-gray-600 transition-colors dark:text-gray-100 dark:group-hover:text-gray-400">
              {post.data.title}
            </h2>
            <p class="text-sm text-gray-500 leading-relaxed mb-4 line-clamp-3 dark:text-gray-400">
              {post.data.description}
            </p>
            <div class="flex flex-wrap gap-1.5 mt-auto">
              {post.data.tags.map(tag => (
                <span class="px-2 py-0.5 text-xs text-gray-500 bg-gray-50 border border-gray-100 rounded-full dark:bg-gray-800 dark:border-gray-700 dark:text-gray-400">
                  {tag}
                </span>
              ))}
            </div>
          </a>
        </article>
      ))}
    </div>

    <p id="no-results" class="hidden text-center text-gray-400 text-sm py-16">
      No hay artículos que coincidan con tu búsqueda.
    </p>

  </main>
  <Footer />
</Layout>

<script>
  function initBlog() {
    let currentTag = ""
    let currentDate = "newest"

    const searchInput = document.getElementById("search") as HTMLInputElement
    const cards = document.querySelectorAll(".post-card") as NodeListOf<HTMLElement>
    const noResults = document.getElementById("no-results")
    const resultsCount = document.getElementById("results-count")

    if (!searchInput) return

    function setupDropdown(
      btnId: string,
      optionsId: string,
      labelId: string,
      chevronId: string,
      optionClass: string,
      onChange: (value: string) => void
    ) {
      const btn = document.getElementById(btnId)!
      const optionsEl = document.getElementById(optionsId)!
      const labelEl = document.getElementById(labelId)!
      const chevronEl = document.getElementById(chevronId)!

      btn.onclick = (e) => {
        e.stopPropagation()
        const isHidden = optionsEl.classList.contains("hidden")
        document.querySelectorAll(".dropdown-options").forEach(el => el.classList.add("hidden"))
        document.querySelectorAll<HTMLElement>(".dropdown-chevron").forEach(el => el.style.transform = "")
        if (isHidden) {
          optionsEl.classList.remove("hidden")
          chevronEl.style.transform = "rotate(180deg)"
        }
      }

      document.querySelectorAll(`.${optionClass}`).forEach(option => {
        (option as HTMLElement).onclick = (e) => {
          e.stopPropagation()
          const value = (option as HTMLElement).dataset.value || ""
          labelEl.textContent = (option as HTMLElement).textContent?.trim() || ""
          optionsEl.classList.add("hidden")
          chevronEl.style.transform = ""
          onChange(value)
          filterPosts()
        }
      })
    }

    function filterPosts() {
      const search = searchInput.value.toLowerCase()

      let visible = Array.from(cards).filter(card => {
        const title = card.dataset.title || ""
        const tags = card.dataset.tags || ""
        const matchSearch = title.includes(search)
        const matchTag = currentTag === "" || tags.split(",").includes(currentTag.toLowerCase())
        return matchSearch && matchTag
      })

      visible.sort((a, b) => {
        const dateA = new Date(a.dataset.date || "").valueOf()
        const dateB = new Date(b.dataset.date || "").valueOf()
        return currentDate === "newest" ? dateB - dateA : dateA - dateB
      })

      cards.forEach(card => card.style.display = "none")

      const grid = document.getElementById("posts-grid")
      visible.forEach(card => {
        card.style.display = "block"
        grid?.appendChild(card)
      })

      resultsCount!.textContent = `${visible.length} artículo${visible.length !== 1 ? "s" : ""}`
      noResults!.classList.toggle("hidden", visible.length > 0)
    }

    setupDropdown("tag-btn", "tag-options", "tag-label", "tag-chevron", "tag-option", (v) => currentTag = v)
    setupDropdown("date-btn", "date-options", "date-label", "date-chevron", "date-option", (v) => currentDate = v)

    document.addEventListener("click", () => {
      document.querySelectorAll(".dropdown-options").forEach(el => el.classList.add("hidden"))
      document.querySelectorAll<HTMLElement>(".dropdown-chevron").forEach(el => el.style.transform = "")
    })

    searchInput.addEventListener("input", filterPosts)
  }

  initBlog()
  document.addEventListener("astro:page-load", initBlog)
</script>